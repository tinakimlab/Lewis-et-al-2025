---
---
#libraries
```{r}
library(tidyverse)
library(dplyr)
library(dslabs)
library(readxl)
library(ggplot2)
library(RColorBrewer)
library(tidyr)
library(openxlsx)
library(svglite)
```

#import files
```{r}
setwd("/Users/Elly/Desktop/Whistler Lab/D3 Project/Behavior Experiments/")
All_Conditioned_place_data <- readxl::read_excel("All Conditioned place data.xlsx", 
                                         sheet = 3)

#sheet is 3 for sga cpa and 2 for coc cpp
cpa_all<- All_Conditioned_place_data

pref_combined <- data.frame(cpa_all %>%
                dplyr:: select(initial_pref, final_pref, mouse_id, drug, treatment, genotype) %>%
      rename(baseline = initial_pref, final = final_pref) %>%
      pivot_longer(cols = c(baseline, final), names_to = "pref", values_to = "percent"))
```

#Figure 1C (cloz cpa)
```{r}
acute_cloz <- data.frame(pref_combined) %>% filter(drug=="cloz") %>% 
  filter(genotype=="WT") %>%
  filter(treatment=="acute")

summary_df <- acute_cloz %>%
  group_by(pref, drug) %>%
  summarize(
    mean = mean(percent, na.rm = TRUE),
    sem = sd(percent, na.rm = TRUE) / sqrt(n()))

plot <- ggplot(acute_cloz, aes(x = pref)) +
  geom_bar(aes(y = percent, fill = drug, color = drug), 
           alpha = 0.5, 
           stat = "summary", 
           fun = "mean",
           width = 0.7) +
  geom_errorbar(data=summary_df, aes(ymin = mean - sem, ymax = mean + sem, color=drug),
                width = 0.2) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 2) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.7) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen")) +
  scale_fill_manual(values=c("cloz"="magenta4"))+
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = str_wrap(c("Baseline", "Final Preference"), width = 10)) +
theme(
    axis.text.x = element_text(size = 25, color = "black"),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(family = "Arial", size = 25),  # Set font to Arial
    plot.title = element_text(hjust = 0.5, family = "Arial"),  # Title font
    axis.line = element_line(size = 1.2),
    axis.text = element_text(family = "Arial"),  # Apply Arial to axis text
    axis.title = element_text(family = "Arial")  # Axis title in Arial
  ) +
  guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 1c.eps", width = 5.2, height = 8, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#Figure 1D (acute quet)
```{r}
acute_quet <- data.frame(pref_combined) %>% filter(drug=="quet") %>% 
  filter(genotype=="WT") %>%
  filter(treatment=="acute")

summary_df <- acute_quet %>%
  group_by(pref, drug) %>%
  summarize(
    mean = mean(percent, na.rm = TRUE),
    sem = sd(percent, na.rm = TRUE) / sqrt(n()))

plot <- ggplot (acute_quet, aes(x=pref)) +
  geom_bar(aes(y = percent, fill = drug, color = drug), 
           alpha = 0.5, 
           stat = "summary", 
           fun = "mean",
           width = 0.7) +
  geom_errorbar(data=summary_df, aes(ymin = mean - sem, ymax = mean + sem, color=drug),
                width = 0.2) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 2) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.7) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "orange", "dmso"="gray40", "quet"="darkgreen")) +
  scale_fill_manual(values=c("quet"="darkgreen"))+
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = str_wrap(c("Baseline", "Final Preference"), width = 10)) +
theme(
    axis.text.x = element_text(size = 25, color = "black"),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(family = "Arial", size = 25),  # Set font to Arial
    plot.title = element_text(hjust = 0.5, family = "Arial"),  # Title font
    axis.line = element_line(size = 1.2),
    axis.text = element_text(family = "Arial"),  # Apply Arial to axis text
    axis.title = element_text(family = "Arial")  # Axis title in Arial
  ) +
  guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 1d.eps", width = 5.2, height = 8, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#Figure 1B (dmso)
```{r}
acute_dmso <- pref_combined %>%
  filter(drug == "dmso", genotype == "WT", treatment == "acute") %>%
  group_by(pref, drug) %>%
  mutate(mean_percent = mean(percent, na.rm = TRUE)) %>%
  ungroup()

summary_df <- acute_dmso %>%
  group_by(pref, drug) %>%
  summarize(
    mean = mean(percent, na.rm = TRUE),
    sem = sd(percent, na.rm = TRUE) / sqrt(n()))

plot <- ggplot(acute_dmso, aes(x=pref)) +
   geom_bar(aes(y = percent, fill = drug, color = drug), 
           alpha = 0.5, 
           stat = "summary", 
           fun = "mean", 
           width = 0.7) +
  geom_errorbar(data=summary_df, aes(ymin = mean - sem, ymax = mean + sem, color=drug),
                width = 0.2) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 2) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.7) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "orange", "dmso"="gray40", "quet"="forestgreen")) +
  scale_fill_manual(values=c("dmso"="gray40"))+
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = str_wrap(c("Baseline", "Final Preference"), width = 10)) +
theme(
    axis.text.x = element_text(size = 25, color = "black"),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(family = "Arial", size = 25),  # Set font to Arial
    plot.title = element_text(hjust = 0.5, family = "Arial"),  # Title font
    axis.line = element_line(size = 1.2),
    axis.text = element_text(family = "Arial"),  # Apply Arial to axis text
    axis.title = element_text(family = "Arial")  # Axis title in Arial
  ) +
  guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color

     # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 1b.eps", width = 5.2, height = 8, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#anova stats
```{r}

#one way anova with repeated measures
# For the 'quet' group
quet_data <- subset(pref_combined, drug == "quet" & treatment=="acute" & genotype=="WT")
anova_quet <- aov(percent ~ pref + Error(mouse_id/pref), data = quet_data)
summary(anova_quet)

# For the 'cloz' group
cloz_data <- subset(pref_combined, drug == "cloz" & treatment=="acute")
anova_cloz <- aov(percent ~ pref + Error(mouse_id/pref), data = cloz_data)
summary(anova_cloz)

# For the 'dmso' group
dmso_data <- subset(pref_combined, drug == "dmso" & treatment=="acute")
anova_dmso <- aov(percent ~ pref + Error(mouse_id/pref), data = dmso_data)
summary(anova_dmso)

# For the 'chronic quet' group
chronicquet_data <- subset(pref_combined, drug == "quet" & treatment=="chronic" & genotype=="WT")
anova_chronicquet <- aov(percent ~ pref + Error(mouse_id/pref), data = chronicquet_data)
summary(anova_chronicquet)

# For the 'chronic cloz' group
chroniccloz_data <- subset(pref_combined, drug == "cloz" & treatment=="chronic" & genotype=="WT")
anova_chroniccloz <- aov(percent ~ pref + Error(mouse_id/pref), data = chroniccloz_data)
summary(anova_chroniccloz)

# For the 'quet DF' group
quet_data <- subset(pref_combined, drug == "quet" & treatment=="acute" & genotype=="DF")
anova_quet <- aov(percent ~ pref + Error(mouse_id/pref), data = quet_data)
summary(anova_quet)

# For the 'chronic quet DF' group
quet_data <- subset(pref_combined, drug == "quet" & treatment=="chronic" & genotype=="DF")
anova_quet <- aov(percent ~ pref + Error(mouse_id/pref), data = quet_data)
summary(anova_quet)

# Combine treatment and drug into a single factor
fold_df <- fold_df %>%
  mutate(group = interaction(treatment, drug))

# Perform Kruskal-Wallis test
kruskal_results <- kruskal.test(fold_change ~ group, data = fold_df)
print(kruskal_results)

# If Kruskal-Wallis test is significant, perform Dunn's test for post-hoc comparisons
if (kruskal_results$p.value < 0.05) {
  dunn_results <- DunnTest(fold_change ~ group, data = fold_df, method = "bonferroni")
  print(dunn_results)
} else {
  cat("Kruskal-Wallis test is not significant; no need for post-hoc comparisons.")
}

```

#Figure 1G(chronic quet)
```{r}
chronic_quet <- data.frame(pref_combined) %>% filter(drug=="quet") %>% 
  filter(genotype=="WT") %>%
  filter(treatment=="chronic")

summary_df <- chronic_quet %>%
  group_by(pref, drug) %>%
  summarize(
    mean = mean(percent, na.rm = TRUE),
    sem = sd(percent, na.rm = TRUE) / sqrt(n()))

plot <- ggplot(chronic_quet, aes(x = pref)) + 
  geom_bar(aes(y = percent, fill = drug, color = drug), 
           alpha = 0.5, 
           stat = "summary", 
           fun = "mean", 
           width=0.7) +
  geom_errorbar(data=summary_df, aes(ymin = mean - sem, ymax = mean + sem, color=drug),
                width = 0.2) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 2) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.7) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen")) +
  scale_fill_manual(values=c("cloz"="magenta4", "quet"="darkgreen"))+
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side \n post Pre-Treatment") +
  scale_x_discrete(labels = str_wrap(c("Baseline", "Final Preference"), width = 10)) +
theme(
    axis.text.x = element_text(size = 25, color = "black"),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(family = "Arial", size = 25),  # Set font to Arial
    plot.title = element_text(hjust = 0.5, family = "Arial"),  # Title font
    axis.line = element_line(size = 1.2),
    axis.text = element_text(family = "Arial"),  # Apply Arial to axis text
    axis.title = element_text(family = "Arial")  # Axis title in Arial
  ) +
  guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 1g.eps", width = 5.2, height = 8, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#Figure 1F (chronic cloz)
```{r}
chronic_cloz <- data.frame(pref_combined) %>% filter(drug=="cloz") %>% 
  filter(genotype=="WT") %>%
  filter(treatment=="chronic")

summary_df <- chronic_cloz %>%
  group_by(pref, drug) %>%
  summarize(
    mean = mean(percent, na.rm = TRUE),
    sem = sd(percent, na.rm = TRUE) / sqrt(n()))

plot <- ggplot (chronic_cloz, aes(x=pref)) +
  geom_bar(aes(y = percent, fill = drug, color = drug), 
           alpha = 0.5, 
           stat = "summary", 
           fun = "mean", 
           width = 0.7) +
  geom_errorbar(data=summary_df, aes(ymin = mean - sem, ymax = mean + sem, color=drug),
                width = 0.2) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 2) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.7) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen")) +
  scale_fill_manual(values=c("cloz"="magenta4"))+
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side \n post Pre-Treatment") +
  scale_x_discrete(labels = str_wrap(c("Baseline", "Final Preference"), width = 10)) +
theme(
    axis.text.x = element_text(size = 25, color = "black"),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(family = "Arial", size = 25),  # Set font to Arial
    plot.title = element_text(hjust = 0.5, family = "Arial"),  # Title font
    axis.line = element_line(size = 1.2),
    axis.text = element_text(family = "Arial"),  # Apply Arial to axis text
    axis.title = element_text(family = "Arial")  # Axis title in Arial
  ) +
  guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 1f.eps", width = 5.2, height = 8, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#fold changes each mouse
```{r}

# Define the fold change function
fold_change <- function(baseline, final) {
  return(final / baseline)
}

# Initialize an empty list to store results
fold_changes <- list()

# Get unique values for each column
unique_mice <- unique(pref_combined$mouse_id)
unique_drugs <- unique(pref_combined$drug)
unique_treatments <- unique(pref_combined$treatment)

# Loop over unique values
for (m in unique_mice) {
  
  for (d in unique_drugs) {
    
    for (t in unique_treatments) {
      
       # Subset data for the current mouse_id, drug, and treatment
      subset_data <- pref_combined[
        pref_combined$mouse_id == m &
        pref_combined$drug == d &
        pref_combined$treatment == t,]
      
      baseline_percent <- subset_data$percent[subset_data$pref == "baseline"]
      final_percent <- subset_data$percent[subset_data$pref == "final"]
        
fc <- fold_change(baseline_percent, final_percent)
      
      # Create a vector with current fold change and identifiers
      fold_change_entry <- c(mouse_id = m, drug = d, treatment = t, fold_change = fc)
      
      # Append to the fold_changes list
      fold_changes <- c(fold_changes, list(fold_change_entry))
    }
  }
}

# Combine the list into a single data frame
fold_df <- bind_rows(fold_changes) %>% 
  drop_na() %>% 
  dplyr::mutate(fold_change = as.numeric(fold_change)) %>%
  dplyr::left_join(pref_combined %>% 
                     dplyr::select(mouse_id, genotype) %>% 
                     dplyr::distinct(), 
                   by = "mouse_id")

#mean fold changes
mean_fold <- fold_df %>%
  group_by(drug, treatment, genotype) %>%
  summarize(
    mean_fold_change = mean(fold_change, na.rm = TRUE),
    sd = sd(fold_change, na.rm = TRUE),
    n = n()
  ) %>%
  mutate(sem = sd / sqrt(n)) %>%
  ungroup()

#median fold
median_fold <- fold_df %>%
  group_by(drug, treatment, genotype) %>%
  summarize(
    median_fold_change = median(fold_change, na.rm = TRUE),
    mad = mad(fold_change, na.rm = TRUE),
    n = sum(!is.na(fold_change)),  # Calculate the sample size (number of non-NA values)
    robust_sem = mad(fold_change, na.rm = TRUE) / sqrt(sum(!is.na(fold_change)))  # Calculate the Robust SEM
  ) %>%
  ungroup()
```


#fold change of means
```{r}
#mean fold changes
mean_pref_combined <- pref_combined %>% group_by(drug, treatment, pref) %>% 
  summarize(mean_percent = mean(percent, na.rm = TRUE)) %>% 
  ungroup()

# Initialize an empty list to store results
fold_changes <- list()

# Loop over unique values
for (d in unique_drugs) {
  for (t in unique_treatments) {
    # Subset data for the current drug and treatment
    subset_data <- mean_pref_combined %>%
      filter(drug == d, treatment == t)
    
    baseline_percent <- subset_data$mean_percent[subset_data$pref == "baseline"]
    final_percent <- subset_data$mean_percent[subset_data$pref == "final"]
    
    fc <- fold_change(baseline_percent, final_percent)
    
    # Create a list with current fold change and identifiers
    fold_change_entry <- list(drug = d, treatment = t, fold_change = fc)
    
    # Append to the fold_changes list
    fold_changes <- c(fold_changes, list(fold_change_entry))
  }
}

# Convert list to data frame
fold_df_meansfirst <- bind_rows(fold_changes) %>%
  drop_na() %>%
  mutate(fold_change = as.numeric(fold_change))
```

#Figure 1E (fold change and alternate options)
```{r}
median_fold <- median_fold %>% dplyr:: filter(drug != "dmso")
ggplot(median_fold, aes(x = factor(drug, levels = c('cloz', 'quet')), y = median_fold_change - 1)) +
  geom_bar(aes(fill = drug, group = treatment), color = "white", stat = "identity", position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = median_fold_change - robust_sem - 1, ymax = 0, fill = treatment, color = drug), width = 0.4, position = position_dodge(width = 1)) +
  labs(title = "Relative Fold Change in Preference",
       x = "Drug",
       y = "Median Fold Change") +
  scale_color_manual(values = c("cloz" = "orange", "quet" = "cadetblue2")) +
  scale_fill_manual(values = c("cloz" = "orange", "quet" = "cadetblue2")) +
  theme_classic() +
  scale_x_discrete(labels = c("Clozapine", "Quetiapine")) +
  scale_y_continuous(breaks = c(-0.6, -0.3, 0.0, 0.3), labels = c(0.4, 0.7, 1.0, 1.3), limits = c(-0.5, 0.3)) +
  theme(
    axis.text.x = element_text(size = 17, color = "black"), # Ensure x-axis labels are shown
    axis.ticks.x = element_line(color = "black"),           # Ensure x-axis ticks are shown
    axis.title.x = element_text(size = 17),                 # Add x-axis title
    text = element_text(size = 17),
    plot.title = element_text(hjust = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  theme(legend.position = 'none')



mean_fold <- mean_fold %>% dplyr:: filter(drug != "dmso")
ggplot(mean_fold, aes(x = factor(drug, levels = c('cloz', 'quet')), y = mean_fold_change - 1)) +
  geom_bar(aes(fill = drug, group = treatment), color = "white", stat = "identity", position = position_dodge(width = 0.9)) +
  geom_errorbar(aes(ymin = mean_fold_change - sem - 1, ymax = 0, fill = treatment, color = drug), width = 0.4, position = position_dodge(width = 1)) +
  labs(title = "Relative Fold Change in Preference",
       x = "Drug",
       y = "Mean Fold Change") +
  scale_color_manual(values = c("cloz" = "orange", "quet" = "cadetblue2")) +
  scale_fill_manual(values = c("cloz" = "orange", "quet" = "cadetblue2")) +
  theme_classic() +
  scale_x_discrete(labels = c("Clozapine", "Quetiapine")) +
  scale_y_continuous(breaks = c(-0.6, -0.3, 0.0, 0.3), labels = c(0.4, 0.7, 1.0, 1.3), limits = c(-0.5, 0.3)) +
  theme(
    axis.text.x = element_text(size = 17, color = "black"), # Ensure x-axis labels are shown
    axis.ticks.x = element_line(color = "black"),           # Ensure x-axis ticks are shown
    axis.title.x = element_text(size = 17),                 # Add x-axis title
    text = element_text(size = 17),
    plot.title = element_text(hjust = 0.5)
  ) +
  geom_hline(yintercept = 0) +
  theme(legend.position = 'none')
```

#Figure 2D (DF acute)
```{r}
acute_quet <- data.frame(pref_combined) %>% filter(drug=="quet") %>% 
  filter(genotype=="DF") %>%
  filter(treatment=="acute")

plot <- ggplot (acute_quet, aes(x=pref)) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 1) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.8) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen")) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = c("Baseline", "Final Preference")) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x.bottom = element_text(size = 25, color = "black"),
        axis.title.x= element_blank(),
        text = element_text(size = 25),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(size = 1.2)) +
  ggtitle("Quetiapine Conditioned") +
   guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  print(plot)
```

#Figure 1H (DF chronic)
```{r}
chronic_quet_df <- data.frame(pref_combined) %>% filter(drug=="quet") %>% 
  filter(genotype=="DF") %>%
  filter(treatment=="chronic")

summary_df <- chronic_quet_df %>%
  group_by(pref, drug) %>%
  summarize(
    mean = mean(percent, na.rm = TRUE),
    sem = sd(percent, na.rm = TRUE) / sqrt(n()))

plot <- ggplot (chronic_quet_df, aes(x=pref)) +
  geom_bar(aes(y = percent, fill = drug, color = drug), 
           alpha = 0.8, 
           stat = "summary", 
           fun = "mean", 
           width=0.7) +
  geom_errorbar(data=summary_df, aes(ymin = mean - sem, ymax = mean + sem, color=drug),
                width = 0.2) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 2, shape= 1) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.7) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen")) +
  scale_fill_manual(values=c("cloz"="magenta4", "quet"="white"))+
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side \n post Pre-Treatment") +
  scale_x_discrete(labels = str_wrap(c("Baseline", "Final Preference"), width = 10)) +
theme(
    axis.text.x = element_text(size = 25, color = "black"),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    text = element_text(family = "Arial", size = 25),  # Set font to Arial
    plot.title = element_text(hjust = 0.5, family = "Arial"),  # Title font
    axis.line = element_line(size = 1.2),
    axis.text = element_text(family = "Arial"),  # Apply Arial to axis text
    axis.title = element_text(family = "Arial")  # Axis title in Arial
  ) +
  guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 1h.eps", width = 5.2, height = 8, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#paired t test stats
```{r}
t_test_results <- list()

for (current_treatment in unique(pref_combined$treatment)) {
  for (current_genotype in unique(pref_combined$genotype)) {
    for (current_drug in unique(pref_combined$drug)) {
      
      # Subset data for the current treatment, genotype, and drug
      subset_data <- pref_combined[pref_combined$drug == current_drug & 
                                    pref_combined$genotype == current_genotype & 
                                    pref_combined$treatment == current_treatment, ]
      
      # Check if there are exactly two levels in the pref column
      if (length(unique(subset_data$pref)) == 2) {
        # Extract percent values for baseline and final
        baseline_values <- subset_data$percent[subset_data$pref == "baseline"]
        final_values <- subset_data$percent[subset_data$pref == "final"]
        
        # Check if we have equal lengths for paired t-test
        if (length(baseline_values) == length(final_values)) {
          # Perform the paired t-test
          t_test_result <- t.test(baseline_values, final_values, paired = TRUE)
          
          # Store results in the list
          t_test_results[[paste(current_genotype, current_drug, current_treatment, sep = "_")]] <- t_test_result
        }
      }
    }
  }
}

# Print the results
print(t_test_results)
```

#unpaired t test (fold change)
```{r}
# Initialize an empty list to store results
t_test_results <- list()

# Get unique groups
unique_groups <- unique(fold_df$group)

# Loop through pairs of groups
for (i in 1:(length(unique_groups) - 1)) {
  for (j in (i + 1):length(unique_groups)) {
    group1 <- unique_groups[i]
    group2 <- unique_groups[j]
    
    # Extract fold_change values for each group
    group1_values <- fold_df$fold_change[fold_df$group == group1]
    group2_values <- fold_df$fold_change[fold_df$group == group2]
    
    # Perform the unpaired t-test
    t_test_result <- t.test(group1_values, group2_values)
    
    # Store results in the list
    t_test_results[[paste(group1, group2, sep = "_vs_")]] <- t_test_result
  }
}

# Print the results
print(t_test_results)

```

#Figure (fold change)
```{r}
fold_quet <- mean_fold %>% dplyr::filter(drug=="quet")

# Apply the custom labels to the x-axis
plot <- ggplot(fold_quet, aes(x = factor(interaction(drug, treatment, genotype), 
                                         levels = unique(interaction(drug, treatment, genotype))), 
                              y = mean_fold_change - 1, 
                              fill = interaction(drug, treatment, genotype), 
                              color = interaction(drug, treatment, genotype))) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_errorbar(aes(ymin = mean_fold_change - sem - 1, ymax = mean_fold_change + sem - 1), 
                width = 0.4, position = position_dodge(width = 1)) +
  scale_color_manual(values = c("quet.acute.DF" = "forestgreen", "quet.acute.WT" = "forestgreen", "quet.chronic.DF" = "forestgreen", "quet.chronic.WT"="forestgreen")) +
  scale_fill_manual(values = c( "quet.acute.DF" = "forestgreen", "quet.acute.WT" = "forestgreen", "quet.chronic.DF" = "forestgreen", "quet.chronic.WT"="forestgreen")) +
  labs(title = "Relative Fold Change in Preference",
       y = "Mean Fold Change") +
  theme_classic() +
  theme(axis.text.x = element_text(size = 22, color = "black"),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        text = element_text(size = 25),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(size = 1.2)) +
  scale_y_continuous(breaks = c(-0.6, -0.3, 0.0, 0.3), 
                     labels = c(0.4, 0.7, 1.0, 1.3), limits = c(-0.7, 0.4)) +
  geom_hline(yintercept = 0) +
  guides(fill = FALSE, color = FALSE) +
  scale_x_discrete(labels = function(x) gsub("\\..*\\.", "\n", x))

print(plot)
```

#fold change stats
```{r}
# Filter the dataframe for the desired subregion
filtered_df <- fold_df[fold_df$drug == "quet", ]

# Create a new factor that combines drug, treatment, and genotype
filtered_df$Group <- interaction(filtered_df$drug, filtered_df$treatment, filtered_df$genotype)

# Perform the one-way ANOVA comparing fold_change between the combined groups
anova_result <- aov(fold_change ~ Group, data = filtered_df)

# Display the ANOVA summary
summary(anova_result)

# Perform Tukey's HSD post hoc test
tukey_result <- TukeyHSD(anova_result)

# Display the results
print(tukey_result)
```

#Figure 2A (coc pref)
```{r}
coc_pref <- data.frame(pref_combined) %>% filter(drug=="coc") %>% 
  filter(genotype=="WT") %>%
  filter(treatment=="acute")

plot <- ggplot (coc_pref, aes(x=pref)) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 1) +
  geom_path(aes(group = mouse_id, y = percent, color = drug), alpha = 0.8) +  
  theme_classic() +
  scale_color_manual(values = c("cloz" = "orange", "dmso"="gray40", "quet"="darkgreen", "coc"="black")) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = c("Baseline", "Final Preference")) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x.bottom = element_text(size = 25, color = "black"),
        axis.title.x= element_blank(),
        text = element_text(size = 25),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(size = 1.2)) +
  ggtitle("WT + \n Cocaine Conditioned") +
   guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 2a.eps", width = 6.3, height = 9,, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#Figure 2B (cloz coc)
```{r}
cloz_coc <- data.frame(pref_combined) %>% filter(drug=="cloz") %>% 
  filter(genotype=="WT") %>%
  filter(treatment=="chronic")

plot <- ggplot(cloz_coc, aes(x=pref)) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 1) +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen", "coc"="black")) +
  geom_path(aes(group = mouse_id, y = percent), color="black", alpha = 0.8) +  
  theme_classic()  +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = c("Baseline", "Final Preference")) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x.bottom = element_text(size = 25, color = "black"),
        axis.title.x= element_blank(),
        text = element_text(size = 25),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(size = 1.2)) +
  ggtitle("WT + \nChronic Clozapine + \nCocaine Conditioned") +
   guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 2b.eps", width = 6.3, height = 9,, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#Figure 2C (quet coc)
```{r}
quet_coc <- data.frame(pref_combined) %>% filter(drug=="quet") %>% 
  filter(genotype=="WT") %>%
  filter(treatment=="chronic")

plot <- ggplot(quet_coc, aes(x=pref)) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 1) +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen", "coc"="black")) +
  geom_path(aes(group = mouse_id, y = percent), color="black", alpha = 0.8) +  
  theme_classic()  +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = c("Baseline", "Final Preference")) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x.bottom = element_text(size = 25, color = "black"),
        axis.title.x= element_blank(),
        text = element_text(size = 25),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(size = 1.2)) +
  ggtitle("WT + \nChronic Quetiapine + \nCocaine Conditioned") +
   guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 2c.eps", width = 6.3, height = 9,, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#Figure 4H (halo cpa)
```{r}
halo_cpa <- data.frame(pref_combined) %>% filter(drug=="lat") %>% 
  filter(genotype=="d3cre") %>%
  filter(treatment=="halo")

plot <- ggplot(halo_cpa, aes(x=pref)) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 1) +
  scale_color_manual(values = c("lat"="darkorange1")) +
  geom_path(aes(group = mouse_id, y = percent), color="darkorange1", alpha = 0.8) +  
  theme_classic()  +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on LED side") +
  scale_x_discrete(labels = c("Baseline", "Final Preference")) +
  theme(axis.text.x = element_text(size = 25, color = "black"),  # Updated
        axis.ticks.x = element_blank(),
        axis.title.x= element_blank(),
        text = element_text(size = 25),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(size = 1.2)) +
  ggtitle(str_wrap("D3::Cre + doublefloxed-NpHR", width=25)) +
  guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color

  
  print(plot)
```


#Figure 2D (DF coc)
```{r}
df_coc <- data.frame(pref_combined) %>% filter(drug=="quet") %>% 
  filter(genotype=="DF") %>%
  filter(treatment=="chronic")

plot <- ggplot(df_coc, aes(x=pref)) +
  geom_point(aes(y = percent, fill = drug, color = drug), size = 1) +
  scale_color_manual(values = c("cloz" = "magenta4", "dmso"="gray40", "quet"="darkgreen", "coc"="black")) +
  geom_path(aes(group = mouse_id, y = percent), color="black", alpha = 0.8) +  
  theme_classic()  +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  ylab("Percent time on Drug side") +
  scale_x_discrete(labels = c("Baseline", "Final Preference")) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x.bottom = element_text(size = 25, color = "black"),
        axis.title.x= element_blank(),
        text = element_text(size = 25),
        plot.title = element_text(hjust = 0.5), 
        axis.line = element_line(size = 1.2)) +
  ggtitle(str_wrap("D3 GASP1 cKO + Chronic Quetiapine + Cocaine Conditioned", width=20)) +
   guides(fill = FALSE, color = FALSE)  # Remove legend for fill and color
  
  
  print(plot)
  
      # Set the working directory
setwd("/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/EPS files")

# Use Cairo EPS device
cairo_ps("fig 2d.eps", width = 6.3, height = 9,, family = "ArialMT", pointsize = 12)

# Create the plot
print(plot)

# Close the Cairo EPS device
dev.off()
```

#exporting raw data figure 1
```{r}
raw_data <- createWorkbook()

fig_labels <- c("Figure 1B", "Figure 1C", "Figure 1D", "Figure 1F", "Figure 1G", "Figure 1H")

dfs_fig <- list(acute_dmso, acute_cloz, acute_quet, chronic_cloz, chronic_quet, chronic_quet_df)

for (i in 1:length(fig_labels)) {
  current_df <- dfs_fig[[i]]
  
  df_wide <- current_df %>%
    pivot_wider(names_from = pref, values_from = percent)
  
  addWorksheet(raw_data, sheetName = fig_labels[i])
  
    writeData(raw_data, sheet = fig_labels[i], df_wide)
}

saveWorkbook(raw_data, "/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/writing/raw_data_fig1.xlsx", overwrite = TRUE)
```

#exporting raw data figure 2
```{r}
raw_data <- createWorkbook()

fig_labels <- c("Figure 2A", "Figure 2B", "Figure 2C", "Figure 2D", "Figure 2F acute", "Figure 2F chronic", "Figure 2G acute", "Figure 2G chronic", "Figure 2H acute", "Figure 2H chronic")

dfs_fig <- list(coc_pref, cloz_coc, quet_coc, df_coc, acute_cloz_loc, chronic_cloz_loc, acute_quet_loc, chronic_quet_loc, acute_quet_loc_df, chronic_quet_loc_df)

for (i in 1:length(fig_labels)) {
  current_df <- dfs_fig[[i]]
  
# Check if the 'pref' column exists in the current data frame
  if ("pref" %in% colnames(current_df)) {
    df_wide <- current_df %>%
      pivot_wider(names_from = pref, values_from = percent)
    
    # Add a new worksheet with the custom sheet name
    addWorksheet(raw_data, sheetName = fig_labels[i])
    
    # Write the pivoted data to the worksheet
    writeData(raw_data, sheet = fig_labels[i], df_wide)
    
  } else if ("Drug" %in% colnames(current_df)) {
    # If 'Drug' column exists, pivot wider with 'Drug' as the new columns
    
    df_wide <- current_df %>%
      group_by(Subject, Drug) %>%  # Group by Subject and Drug to ensure proper aggregation
      summarise(Ambulatory_Distance = mean(Ambulatory_Distance, na.rm = TRUE)) %>%  # Aggregate by mean
      pivot_wider(names_from = Drug, values_from = Ambulatory_Distance) %>%
      ungroup()  # Ungroup after pivoting
    
    # Add a new worksheet with the custom sheet name
    addWorksheet(raw_data, sheetName = fig_labels[i])
    
    # Write the pivoted data to the worksheet
    writeData(raw_data, sheet = fig_labels[i], df_wide)
    
  }
}

saveWorkbook(raw_data, "/Users/Elly/Desktop/Kim Lab-Whistler Lab/D3 Behavior Manuscript/writing/raw_data_fig2.xlsx", overwrite = TRUE)
```